<section class="cadastro-page cadastro-page--compact">
  <div class="card cadastro-card">
    <h1 class="cadastro-titulo">{{ tituloPagina }}</h1>
    <form [formGroup]="formServico" (ngSubmit)="salvarServico()" novalidate class="cadastro-form">
      <div>
        <label class="form-label" for="nome">Nome do Serviço</label>
        <input id="nome" type="text" class="form-control" formControlName="nome" placeholder="Ex: Lavagem Completa" />
        <div class="text-danger pequeno" *ngIf="obterControle('nome')?.invalid && obterControle('nome')?.touched">
          <span *ngIf="obterControle('nome')?.errors?.['required']">Nome é obrigatório.</span>
          <span *ngIf="obterControle('nome')?.errors?.['minlength']">Nome deve ter pelo menos 3 caracteres.</span>
        </div>
      </div>

      <div>
        <label class="form-label" for="preco">Preço</label>
        <input id="preco" type="number" class="form-control" formControlName="preco" placeholder="Ex: 150.00" min="0" step="0.01" />
        <div class="text-danger pequeno" *ngIf="obterControle('preco')?.invalid && obterControle('preco')?.touched">
          <span *ngIf="obterControle('preco')?.errors?.['required']">Preço é obrigatório.</span>
          <span *ngIf="obterControle('preco')?.errors?.['min']">Preço deve ser maior ou igual a 0.</span>
        </div>
      </div>

      <div>
        <label class="form-label" for="descricao">Descrição</label>
        <textarea
          id="descricao"
          class="form-control textarea-fixed"
          formControlName="descricao"
          rows="3"
          maxlength="150"
          placeholder="Detalhe o serviço de forma objetiva (máx. 150 caracteres)"
        ></textarea>
        <div class="text-end pequeno mt-1">
          {{ contarCaracteresDescricao() }}/150
        </div>
      </div>

      <div>
        <label class="form-label">Produtos do Serviço</label>
        <button type="button" class="btn btn-anexar-produtos" (click)="abrirSelecaoProdutos()">
          <i class="bi bi-box-seam"></i>
          Anexar Produtos
          <span class="badge-produtos" *ngIf="produtosSelecionados.length > 0">{{ produtosSelecionados.length }}</span>
        </button>
        <div class="produtos-selecionados-resumo" *ngIf="produtosSelecionados.length > 0">
          <span class="pequeno text-muted">{{ produtosSelecionados.length }} produto(s) selecionado(s)</span>
        </div>
      </div>

      <div class="cadastro-actions">
        <button type="submit" class="btn btn-primary" [disabled]="formServico.invalid">Salvar</button>
        <button type="button" class="btn btn-outline-danger" (click)="limparFormulario()">Limpar</button>
      </div>
    </form>
  </div>
</section>

<!-- Modal de Seleção de Produtos -->
<div class="modal-overlay" *ngIf="mostrarModalProdutos" (click)="fecharSelecaoProdutos()">
  <div class="modal-produtos" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-titulo">Selecione os Produtos para o Serviço</h2>
      <button type="button" class="btn-fechar" (click)="fecharSelecaoProdutos()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="listas-container">
        <div class="lista-wrapper">
          <h3 class="titulo-lista">Produtos Disponíveis</h3>
          <div
            id="produtos-disponiveis"
            cdkDropList
            #listaDisponiveis="cdkDropList"
            [cdkDropListData]="produtosDisponiveis"
            [cdkDropListConnectedTo]="[listaSelecionados]"
            (cdkDropListDropped)="aoOrganizarProdutos($event)"
            class="lista-produtos"
          >
            <p class="texto-vazio" *ngIf="produtosDisponiveis.length === 0">Nenhum produto disponível.</p>
            <div class="item-produto" *ngFor="let produto of produtosDisponiveis" cdkDrag>
              <span class="nome-produto">{{ produto.nome }}</span>
              <span class="valor">{{ produto.preco | currency: 'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
            </div>
          </div>
        </div>

        <div class="lista-wrapper">
          <h3 class="titulo-lista">Produtos Selecionados</h3>
          <div
            id="produtos-selecionados"
            cdkDropList
            #listaSelecionados="cdkDropList"
            [cdkDropListData]="produtosSelecionados"
            [cdkDropListConnectedTo]="[listaDisponiveis]"
            (cdkDropListDropped)="aoOrganizarProdutos($event)"
            class="lista-produtos"
          >
            <p class="texto-vazio" *ngIf="produtosSelecionados.length === 0">Arraste os produtos desejados para cá.</p>
            <div class="item-produto" *ngFor="let produto of produtosSelecionados" cdkDrag>
              <span class="nome-produto">{{ produto.nome }}</span>
              <span class="valor">{{ produto.preco | currency: 'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" (click)="fecharSelecaoProdutos()">Confirmar</button>
    </div>
  </div>
</div>